jobs:
  run-script:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Force non-Azure Ubuntu mirrors
        run: |
          # 备份原配置
          sudo cp /etc/apt/sources.list /etc/apt/sources.list.backup
          # 替换所有可能的Azure镜像
          sudo sed -i 's|http://[a-z]*\.archive\.ubuntu\.com|http://archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|https://[a-z]*\.archive\.ubuntu\.com|https://archive.ubuntu.com|g' /etc/apt/sources.list
          # 删除所有Azure相关源文件
          sudo rm -f /etc/apt/sources.list.d/azure* 2>/dev/null || true
          
      - name: Verify no Azure sources
        run: |
          echo "=== 检查APT源 ==="
          grep -r "azure" /etc/apt/sources.list /etc/apt/sources.list.d/ 2>/dev/null || echo "未发现Azure源 - 通过检查"
          
      - name: Safe apt update
        run: sudo apt-get update -y
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install dependencies (PyPI only)
        run: |
          pip install --no-cache-dir --index-url https://pypi.org/simple filelock -v
          
      - name: Run script
        run: python3 RSA_management_updated.py --help
